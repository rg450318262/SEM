---
title: "COS-D419 Factor Analysis and Structural Equation Models 2023, Assignment 4"
author: "Rong Guang"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    latex_engine: lualatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, cache = F, fig.align = 'center')
```

**\textcolor{blue}{The texts that reflect my understanding have been highlighted in} \textcolor{red}{red color}.** 

# Task description

The first section is task description, which is copied from the assignment5.rmd. It is for communicating with future "me". Please skip it.

## Exercise 5.1

Specify and estimate the initial baseline models for the two groups. 

Present a brief summary of the model fit and make the first step of the modification by including **(exceptionally, at the same time!)** all the four parameters known to be required for improving the model fit of both models.

Fine-tune the models step by step following the guidelines given in the lecture material, i.e., implement the modifications **(as usually, one change at a time)** testing and studying each step. 

Present the final baseline models of each group and draw the graphs

# Preparation

##Read in the data set:

Start by downloading the **two data files** from Moodle to your Project folder!

```{r}
#install the necessary pakages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(here, 
               expss, 
               tidyverse, 
               janitor,
               knitr, 
               qualtRics, 
               arules, 
               arulesViz, 
               sjlabelled,
               DT,
               stringr,
               labelled,
               ggstatsplot,
               ggcorplot)

library(tidyverse)
library(readr)

#This week's file name
latest.name1 <- "MBIELM1.CSV"
latest.name2 <- "MBISEC1.CSV"
#read in the data
mbi.elm <-  #elementary school
  read_csv(
    file.path(
      here(),
      'data',
      latest.name1
      )
    )

mbi.sec <- #secondary school
  read_csv(
    file.path(
      here(),
      'data',
      latest.name2
      )
    )

```

## Write functions

To control length of reports, codes already shown in the previous homework were not showing in the current report. Yet they are available in .rmd report.

### To generate a function for calculating chi square difference was defined.

```{r, echo = F}
chi.diff <- function(sem1, sem2){ #2 augments input: the 1st is the nested model
                                  #the 2nd is comparison model (less restricted)
  measure0 <- fitMeasures(sem1,  #extract robust fit indices for the 1st model
                          c("df.scaled",
                            "chisq.scaling.factor",
                            "chisq.scaled")) |>
    as.vector()   #turn to vector to facilitate calculation
  measure1 <- fitMeasures(sem2,  #extract robust fit indices for the 2nd model
                          c("df.scaled",
                            "chisq.scaling.factor",
                            "chisq.scaled")) |>
    as.vector()
  cd <-  # this is the formula from p 14, week 4 slide
    (measure0[1]*measure0[2]-measure1[1]*measure1[2])/(measure0[1]-measure1[1])
  TRd <- # this is the formula from p 15, week 4 slide
    (measure0[3]*measure0[2]-measure1[3]*measure1[2])/cd
  TRd <- TRd |> round(3) # round the value to 3 decimal places
}
```

### to generate CFA results with improved readability

```{r, echo = F}
#goodness of fit indicators for ml
cfa.summary.mlm.a <- function(fit){
  options(scipen = 999)
  cfa.measure <- fitMeasures(fit,    #obtain specified measured.
                            c("chisq.scaled", 
                              "df.scaled", 
                              "pvalue.scaled", 
                              "cfi.scaled", 
                              "tli.scaled",
                              "rmsea.scaled",
                              "rmsea.pvalue.scaled",
                              "srmr_bentler",
                              "chisq.scaling.factor")) 
  names(cfa.measure) <- c("chi square", "df", "p value", "CFI", "TLI", "RMSEA", "RMSEA p value", "SRMR", "CSF")
  #turn named vector to data frame
cfa.tab.a <- cfa.measure %>%  
  tibble(name= names(cfa.measure), value = cfa.measure) %>% # vector to df
  select(Measure = name, Value = value) %>%  #select and rename columns
  mutate(Value = round(as.numeric(Value),3)) 
}
#factor loading
cfa.summary.b <- function(fit, fa.num, item.num, estimator){
  options(scipen = 999)
  #factor loading
  cfa.tab.b <- parameterEstimates(fit, standardized=TRUE) %>% # obtain estimates
  filter(op == "=~") %>%  #select "is measured by" rows
  mutate(Parameter = paste0(lhs, "→", rhs),
         pvalue = case_when(as.numeric(pvalue)<0.001~"<0.001", 
                            as.numeric(pvalue)>=0.001~as.character(pvalue)
                            )
         ) |> 
  select(Parameter,
         Beta=std.all, #std estimates
         SE=se, #standard error
         Z=z, #z statistics
         'p-value'=pvalue #p value
         ) 
  # %>%  
  # kable(digits = 3, #rounded to 3
  #       format="markdown", #Latex markdown
  #       booktabs=TRUE, #Latex booktabs
  #       caption=paste("Factor Loadings for",fa.num,"factor CFA model estimated by ", estimator)) %>% #caption
  # kable_styling(latex_options = "striped") %>% #gray every other row
  # row_spec(0, background = "#9999CC") # color the first row
  # cfa.tab.b
  }

#Variance
cfa.summary.c <- function(fit, fa.num, item.num, estimator){
  options(scipen = 999)
  #Variance
  type <- rep(c("Residual", "Total"), 
            time = c(item.num, fa.num)) #create a new row clarifying types of variance

variance <- parameterEstimates(fit, standardized=TRUE) %>% #obtain estimates
  filter(op == "~~") #select "is correlated with" rows
variance <- variance[1:sum(item.num,fa.num),] #subset 1:18 rows (variance row)
variance <- cbind(type, variance) #add column
cfa.tab.c <- variance |> 
  mutate(pvalue = case_when(as.numeric(pvalue)<0.001~"<0.001", 
                            as.numeric(pvalue)>=0.001~as.character(pvalue)
                            )) |> 
  select(Parameter = type, #select and rename variables
                   Indicator=rhs, #right hand side column
                   B=est, #estimates
                   "Beta*"=std.all,#std estimates
                   SE=se,#standard error
                   Z=z, #z statistics
                   'p-value'=pvalue #p value
                   ) 

# %>% 
#   kable(digits = 3, #rounded
#         format="markdown",  #Latex markdown
#         booktabs=TRUE, #Latex booktabs
#         caption=paste("Variances for", fa.num, "factor model estimated by ", estimator)) %>% #caption
#   kable_styling(latex_options = "striped") %>% # gray every other row
#   row_spec(0, background = "#9999CC") # color the variable row
#   cfa.tab.c
}

#Covariance
cfa.summary.d <- function(fit, fa.num, item.num, estimator){
  options(scipen = 999)
  #covariance
  variance <- parameterEstimates(fit, standardized=TRUE) %>%
  filter(op == "~~")
  covar.num = (fa.num+(fa.num-1))/2
variance <- variance[sum(item.num,fa.num,1):sum(item.num,fa.num,covar.num),]
type <- paste(variance$lhs, "←→", variance$rhs) 
variance <- cbind(type, variance)
rownames(variance) <- NULL
cfa.tab.d <- variance |> 
  mutate(pvalue = case_when(as.numeric(pvalue)<0.001~"<0.001", 
                            as.numeric(pvalue)>=0.001~as.character(pvalue)
                            )) |> 
  select(Parameter=type,
         B=est, 
         Beta=std.all,
         SE=se,
         Z=z, 
         'p-value'=pvalue 
         )
# %>% 
#   kable(digits = 3, 
#         format="markdown", 
#         booktabs=TRUE, 
#         caption=paste("Covariances for", fa.num, 
#                       "factor model estimated by ", 
#                       estimator)) %>% 
#   kable_styling(latex_options = "striped") %>% 
#   row_spec(0, background = "#9999CC")
#   cfa.tab.d
}

```


###Write a function to generate aligned residual variance and co-variance tables

```{r}
align.table <- function(data, num.no.header.col, title){

data  |> 
  kable(
    digits = 3,
    booktabs = T,
    #format = "markdown",
    caption = title,
    linesep = ""
    ) |>  
  add_header_above(c(" " = num.no.header.col, 
                     "Elementary level" = 5,
                     "Secondary level" = 5
                     )
                   ) |> 
  kable_styling(
    latex_options = "striped"
  ) |> 
  footnote(
           symbol = c(
             "Un-standardized estimates",
             "Standardized estimates"
                      )
           )
}
```

### Write a function for correlation matrix with numbers

```{r, echo = F}
mymatrix <- function(data, fig.num = 3){
  library(GGally)
ggcorr(data, 
       geom = "blank", 
       label = TRUE, 
       hjust = 0.9, 
       color = "red", 
       face = "bold", 
       method = c("pairwise","pearson"),
       digits = 2,
       size= 2.5,
       label_size = 2.5,
       label_round = 2,
       layout.exp =1) +
  geom_point(size = 7, 
             aes(color = "steelblue", 
                 alpha = abs(coefficient) > 0.3)) +
  scale_alpha_manual(values = c("TRUE" = 0.4, 
                                "FALSE" = 0)) +
    geom_point(size = 8, 
               aes(color = "red", 
                   alpha = abs(coefficient) > 0.6)) +
  scale_alpha_manual(values = c("TRUE" = 0.4, 
                                "FALSE" = 0)) +
  guides(color = FALSE, 
         alpha = FALSE) +
  labs(title = paste("Figure ", fig.num," Pearson correlation matrix of the selected items"),
       caption = 
         " Red circles indicates the absolute of correlation coefficient >= 0.6 
        green circle indicates >= 0.3")+
  theme(plot.title = element_text(size = 12,
                                  face = "bold",
                                  hjust = 0.5),
        plot.caption = element_text(color = "red"))
}

```

### to generate a function for histogram overlapping with density plot

```{r, echo = F}
corr.density <- function(data, fig.num = 1){
  data %>% 
  pivot_longer(everything()) %>%  #longer format
  ggplot(aes(x = value)) + #x axis used variable "value" (a default of pivot)
  geom_histogram(binwidth = 1, aes(y = ..density..), #match ys of density and histogram plots
                 color = "black",  fill = "#9999CC")+  # adjust aesthetics for hist
  geom_density(fill = "pink", alpha = 0.25)+ #adjust aesthetics for density plot
  facet_wrap(~name, scales = "free", ncol =4) + #wrap by name variable
  theme(panel.grid.major = element_blank(), #get rid of the  grids
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white",#adjust the background
                                        color = "black"),
        strip.background = element_rect(color = "black",#adjust the strips aes
                                        fill = "steelblue"),
        strip.text = element_text(size =8, color = "white"), #adjust strip text
        axis.title.x = element_text(size = 3), #adjust the x text
        axis.title.y = element_text(size = 3), # adjust the y text
        plot.title = element_text(size = 12, 
                                  face = "bold",
                                  hjust = 0.5))+ #adjust the title
  labs(title = paste("Figure ", fig.num," Distribution of selected items")) #title it
  }

```

### to generate a function for violin overlapping with box plot

```{r, echo = F}
violin.box <- function(data, fig.num = 2){
  mbi.long <- data %>% pivot_longer(everything(), names_to = "item", values_to = "score")

mbi.long %>% 
  ggplot(aes(x = item, y = score)) +
  geom_violin(trim=F, fill = "#9999CC") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust =1),
        axis.title = element_text(size = 12),
        panel.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(face="bold",
                                  hjust = 0.5),
        axis.title.x = element_blank())+
  labs(x = "Item", 
       y = "Score",
       title = paste("Figure 2 ", fig.num, " Violin plot of the selected items"))+
  geom_boxplot(width = 0.1, fill = "white")
}
```

### To generate a function describing continuous data set

```{r, echo=F}
descriptive <- function(data){
  library(finalfit)
library(kableExtra)
inspect.table <- ff_glimpse(data)$Continuous
inspect.table$label <- NULL
inspect.table %>% 
  mutate('Q1Q3' = paste(quartile_25, 
                        quartile_75, 
                        sep = " ~ ")) %>% 
  select(n, 
         'n of NA' = missing_n, 
         'Mean' = mean, 
         'Median' = median,
         'SD' = sd, 
         'Min' = min, 
         'Max' = max,
         'Q1~Q3' = Q1Q3) %>%
  kable(booktabs = T,  
        align = "r",
        longtable = T,
        linesep = "",
        caption = "Descriptive statistics for measurements") %>% 
  add_header_above(c(" ", 
                     " " = 2,
                     "Central tendency" = 2, 
                     "Dispersion tendency" = 4)) %>% 
  kable_styling(latex_options = c("striped", 
                                  "repeat_header")) %>% 
  column_spec(1, width = "3cm")
}
```

### Write a function describing continuous data set

```{r, echo=F}
descriptive <- function(data){
  library(finalfit)
library(kableExtra)
inspect.table <- ff_glimpse(data)$Continuous
inspect.table$label <- NULL
inspect.table %>%
  mutate('Q1Q3' = paste(quartile_25,
                        quartile_75,
                        sep = " ~ ")) %>%
  select(n,
         'n of NA' = missing_n,
         'Mean' = mean,
         'Median' = median,
         'SD' = sd,
         'Min' = min,
         'Max' = max,
         'Q1~Q3' = Q1Q3) %>%
  kable(booktabs = T,
        align = "r",
        longtable = T,
        linesep = "",
        caption = "Descriptive statistics for measurements") %>%
  add_header_above(c(" ",
                     " " = 2,
                     "Central tendency" = 2,
                     "Dispersion tendency" = 4)) %>%
  kable_styling(latex_options = c("striped",
                                  "repeat_header")) %>%
  column_spec(1, width = "3cm")
}
```

### Write a function for histogram overlapping with density plot

```{r, echo = F}
corr.density <- function(data, fig.num = 1, group){
  data %>%
  pivot_longer(everything()) %>%  #longer format
  ggplot(aes(x = value)) + #x axis used variable "value" (a default of pivot)
  geom_histogram(binwidth = 1, aes(y = ..density..), #match ys of density and histogram plots
                 color = "black",  fill = "#9999CC")+  # adjust aesthetics for hist
  geom_density(fill = "pink", alpha = 0.25)+ #adjust aesthetics for density plot
  facet_wrap(~name, scales = "free", ncol =5) + #wrap by name variable
  theme(panel.grid.major = element_blank(), #get rid of the  grids
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white",#adjust the background
                                        color = "black"),
        strip.background = element_rect(color = "black",#adjust the strips aes
                                        fill = "steelblue"),
        strip.text = element_text(size =8, color = "white"), #adjust strip text
        axis.title.x = element_text(size = 3), #adjust the x text
        axis.title.y = element_text(size = 3), # adjust the y text
        plot.title = element_text(size = 12,
                                  face = "bold",
                                  hjust = 0.5))+ #adjust the title
  labs(title = paste("Figure", fig.num," Distribution of selected items for", group)) #title it
  }
```

### Write a function to generate dot distribution plot

```{r}
dot.dist <- 
  function(data, type, title){
    data |>
      t() |> 
      as.data.frame() %>% 
      mutate(Item = rownames(.)) |> 
      rowwise() |> 
      mutate(Median = eval(parse(text = type))(V1:V580)) |> 
      ggstatsplot::ggdotplotstats(
        point.args = list(color = "red", size = 3, shape = 13),
        xlab = paste(type, "ratings"),
        title = title,
        x = Median,
        y = Item
      )
    }
```

### Write a fuction to generate correlation matrix with statistical test

```{r}
mycor <- 
  function(data, cols, title){
  mbi.elm |> 
      select(all_of(cols)) |> 
      ggstatsplot::ggcorrmat(
        colors = c("#B2182B", "white", "#4D4D4D"),
        title = "(a) Items on emotional exhaustion, 
        elementary school teacher",
        matrix.type  = "lower"
      )
    }
```

# Inspect the data

## Distribution

```{r,fig.width= 8, fig.height = 13}
#generate the plots, by subgroup of teachers
p.dist.elm <- 
  corr.density(
    mbi.elm, 
    fig.num = "1(a)", 
    group = "elementary school teacher"
    )
p.dist.sec <- 
  corr.density(
    mbi.sec, 
    fig.num = "1(b)",
    group = "secondary school teacher"
    )
#print the plot
library(patchwork); p.dist.elm/p.dist.sec
```

 
```{r,fig.width= 8, fig.height = 5}
#generate plot by subgroups of teachers
p.dot.elm <- 
  dot.dist(
    data = mbi.elm, 
    type = "median", 
    title = "(a) Elementary school teacher"
    )
p.dot.sec <- 
  dot.dist(
    data = mbi.sec, 
    type = "median", 
    title = "(b) Secondary school teacher"
    )
#plot layout
patchwork <- p.dot.elm|p.dot.sec
#print the plot with a genral title
patchwork+plot_annotation(
    title = 
      'Figure 2 Distributions of median rating for each item',
    theme = 
      theme(plot.title = 
              element_text(
                size = 16,
                face = "bold",
                vjust = -1.5,
                hjust =0.5)
            )
    )
```


```{r,fig.width= 10, fig.height = 15}
fa.ee <- c("ITEM1", "ITEM3", "ITEM6", "ITEM8", "ITEM13", "ITEM14", "ITEM16", "ITEM20")
fa.dp <- c("ITEM5", "ITEM10", "ITEM11", "ITEM15", "ITEM22")
fa.pa <- c("ITEM4", "ITEM7", "ITEM9", "ITEM12", "ITEM17", "ITEM18", "ITEM19", "ITEM21")
#generate 6 plots, 3 factors X 2 subgroups of teachers
p.cor.elm.ee <- 
       mycor(
         data= mbi.elm, 
         cols = fa.ee, 
         "(a) Items on emotional exhaustion, 
         elementary school teacher"
         )
p.cor.sec.ee <- 
       mycor(
         data = mbi.sec, 
         cols = fa.ee, 
         "(b) Items on emotional exhaustion, 
          secondary school teacher"
         )
p.cor.elm.dp <- 
       mycor(
         data = mbi.elm, 
         cols = fa.dp, 
         "(c) Items on depersonalization,
          elementary school teacher"
         )
p.cor.sec.dp <- 
       mycor(
         data = mbi.sec, 
         cols = fa.dp, 
         "(d) Items on depersonalization,
          secondary school teacher"
         )
p.cor.elm.pa <- 
       mycor(
         data = mbi.elm, 
         cols = fa.pa, 
         "(e) Items on personal accomplishment,
         secondary school teacher"
         )
p.cor.sec.pa <- 
       mycor(
         data = mbi.sec ,
         cols = fa.pa, 
         "(f) Items on personal accomplishment,
          secondary school teacher"
         )
#plot sub-figure layout
patchwork <- 
  p.cor.elm.ee/p.cor.elm.dp/p.cor.elm.pa|p.cor.sec.ee/p.cor.sec.dp/p.cor.sec.pa 
#print the plot with a gernal title
patchwork+
  plot_annotation(
    title = 
      'Figure 3 Correlalogram for items on each factor for two groups of teachers',
    theme = 
      theme(plot.title = 
              element_text(
                size = 16,
                face = "bold",
                vjust = -1.5,
                hjust =0.5)
            )
    )

```

# Testing the factorial invariance of MBI inventory between elementary and secondary school teachers  

## Define and estimate initial models for both subgroups

The model under test in this initial multi-group application is the same postulated three-factor structure of the MBI that was tested in the previous assignments. 

### Define the baseline model 

```{r}
library(lavaan)
# Define a CFA model using the lavaan (Latent Variable Analysis) syntax:
# see https://lavaan.ugent.be/tutorial/syntax1.html
BLmodel <- '
# CFA model for the burnout, the baseline model:
    EE =~ ITEM1 + ITEM2 + ITEM3 + ITEM6 + ITEM8 + 
          ITEM13 + ITEM14 + ITEM16 + ITEM20
    DP =~ ITEM5 + ITEM10 + ITEM11 + ITEM15 +ITEM22
    PA =~ ITEM4 + ITEM7 + ITEM9 + ITEM12 + 
          ITEM17 + ITEM18 + ITEM19 + ITEM21
          '
```

It is important to note that measuring instruments are often group specific in the way they operate, and, thus, it is possible that baseline models may not be completely identical across groups

### Estimate factorial validity 

(1) Estimate factorial validity for the elementary teacher subgroup

```{r}
cfa.elm <- 
  cfa(
    BLmodel, 
    data = mbi.elm,  
    estimator = "MLM",
    mimic = "Mplus"
    )
```

(2) Estimate factorial validity for the secondary teacher subgroup

```{r}
cfa.sec <- 
  cfa(
    BLmodel, 
    data = mbi.sec,  
    estimator = "MLM",
    mimic = "Mplus"
    )
```

### Evaluate model

(1) Fit indices

```{r}
library(knitr);library(kableExtra)
#combine fit indices of both levels
BL.elm.fit <- cfa.summary.mlm.a(cfa.elm) |> t() |> as.data.frame()
BL.sec.fit <- cfa.summary.mlm.a(cfa.sec) |> t() |> as.data.frame()
BL.both <- rbind(BL.elm.fit[2,], BL.sec.fit[2,]) 
names(BL.both) <- BL.elm.fit[1,]
rownames(BL.both) <- c("Elementary level",
                       "Secondary level")
#improve the readability of the combined table
BL.both <- BL.both |> 
  rename(p = 'p value',
         p2 = 'RMSEA p value',
         chi = 'chi square') |> 
  mutate(df = as.numeric(df) |> round(0),
         p = case_when(
           as.numeric(p) < 0.001 ~ "<0.001",
           as.numeric(p) >= 0.001 ~ p
           ),
         p2 = case_when(
           as.numeric(p2) < 0.001 ~ "<0.001",
           as.numeric(p2) >= 0.001 ~ p2
           )
         ) |>
  mutate('Chi square (df, p)' = 
           paste0(chi, "(", df,", ", p, ")"),
         'RMSEA(p)'           = 
           paste0(RMSEA, "(", p2, ")"
                  )
         ) |> 
  select('Chi square (df, p)', 
         CFI, TLI, 
         'RMSEA(p)', 
         SRMR, 
         'CSF*'= CSF
         ) 
#print the combined table with adjustment of aesthetics
BL.both |> 
  kable(booktabs = T, 
        #format = "markdown", 
        caption = 
          "Fit indices for two subgroups, basline models",
        align = "r"
        ) |> 
  kable_styling(full_width = T) |> 
  footnote(symbol = 
             "Chi square scaling factor"
           ) |>
  column_spec(1, width = "3cm") |> 
  column_spec(2, width = "4cm")|> 
  column_spec(3, width = "1cm")|> 
  column_spec(4, width = "1cm")|> 
  column_spec(5, width = "2.5cm")|> 
  column_spec(6, width = "1cm") |> 
  column_spec(7, width = "1cm") 
```

\textcolor{blue}{See table 1. Goodness-of-fit statistics for this baseline model (three factor) reveals that the indices are less than optimal for both elementary (MLM Chi-square[206] = 826.573; CFI = 0.857; RMSEA = 0.072 ; SRMR = 0.068) and secondary (MLM Chi-square[206] = 999.359; CFI = 0.836; RMSEA = 0.075; SRMR = 0.077) levels.}

(2) factor loading

Factor loading of elementary level were extracted.

```{r}
fl.elm <- cfa.summary.b (cfa.elm) #fl  is for factor loading)
colnames(fl.elm)[2] <- "Beta*"
```

Factor loading of secondary level were extracted.

```{r}
fl.sec <- cfa.summary.b (cfa.sec) #fl is for factor loading
colnames(fl.sec) <- c("Parameter",
                     "Beta* ",
                     "SE ",
                     "Z ",
                     "p-value ")
```

Factor loading of both levels were merged in one table and printed.

```{r}
fl.both <- left_join(fl.elm, 
                     fl.sec, 
                     by = "Parameter")
fl.both |> 
  kable(
    digits = 3,
    booktabs = T,
    #format = "markdown",
    caption = "Factor loadings for both levels",
    linesep = ""
    ) |>  
  add_header_above(c(" " = 1, 
                     "Elementary level" = 4,
                     "Secondary level" = 4
                     )
                   ) |> 
  kable_styling() |> 
  row_spec(1:9, 
           background = "#E5E4E2"
           ) |> 
  row_spec(15:22, 
           background = "#E5E4E2"
           ) |> 
  row_spec(c(1,10,15), bold = T) |> 
  footnote(general = 
             "Rows with coeffcient estimates fixed to 1 are highligted in bold ",
           symbol = c(
             "Standardized estimates"
                      )
           )
  
```

the cross-loading involved the loading of Item 12 on Factor 1 (Emotional Exhaustion) in addition to its targeted Factor 3 (Personal Accomplishment)

(3) Variance 

Variance of elementary level were extracted.

```{r}
var.elm <- cfa.summary.c(cfa.elm, fa.num = 3, item.num = 22)
names(var.elm)[3] <- "Beta*"
names(var.elm)[4]<- "Beta†"
```

Variance of secondary level were extracted.

```{r}
var.sec <- cfa.summary.c(cfa.sec, fa.num = 3, item.num = 22)
var.sec <- var.sec[,-1]
names(var.sec) <- 
  c("Indicator", 
    "Beta* ", 
    "Beta† ",
    "SE ", 
    "Z ", 
    "p-value "
    )
```

Variance of both levels were merged in one table and printed.

```{r}
var.both <- left_join(var.elm, 
                     var.sec, 
                     by = "Indicator")

align.table(data = var.both, 
            num.no.header.col = 2, 
            title = "Residual variance for both levels")
```

(3) Co-variance

Co-variance of elementary level were extracted.

```{r}
cov.elm <- cfa.summary.d(cfa.elm, fa.num = 3, item.num = 22)
colnames(cov.elm)[2:3] <- c("Beta*", "Beta†")
```

Co-variance of secondary level were extracted.

```{r}
cov.sec <- cfa.summary.d(cfa.sec, fa.num = 3, item.num = 22)
colnames(cov.sec) <- c("Parameter", "Beta* ", "Beta† ", "SE ", "Z ", "p-value ")
```

Co-variance of both levels were merged in one table and printed.

```{r}
cov.both <- left_join(cov.elm, 
                     cov.sec, 
                     by = "Parameter")

align.table(data = cov.both, 
            num.no.header.col = 1, 
            title = "Residual co-variance for both levels")
```

### Model re-specification

MIs of elementary level panel were calculated.

```{r}
#extract needed variables
BL.MI.elm <- 
  modindices(cfa.elm,
             standardized = TRUE,
             sort. = TRUE,
             maximum.number = 10)
```

MIs of secondary level panel were calculated.

```{r}
#extract needed variables
BL.MI.sec <- 
  modindices(cfa.sec,
             standardized = TRUE,
             sort. = TRUE,
             maximum.number = 10)
```

MI tables with 10 largest MI parameters was printed in descending order of MI. Potential mis-specification of most concerns were highlighted in red.

```{r}
MI.both <- rbind(BL.MI.elm, BL.MI.sec)

MI.both    |> 
  mutate(Parameter = 
           paste(rhs, "→", lhs)
         ) |>
  select(Parameter, 
         MI = mi, 
         EPC = epc, 
         "std EPC" = sepc.all
         )|>
  kable(digits = 3,
        booktab = T,
        linesep = "",
        caption = 
          "Selected modification indices for determining baseline model") |>
  kable_styling(
    latex_options = "striped"
    ) |>
  row_spec(
    1:4, 
    color = "red"
    ) |> 
  footnote(general = 
             "Rows highlighted in red are of special concerns") |> 
  pack_rows(index = c(
    "Elementary level" = 10,
    "Secondary level" = 10
    )
    )
```

Three exceptionally large residual co-variances and one cross-loading contributed to the misfit of the model for both teacher panels. The residual co-variances involved Items 1 and 2, Items 6 and 16, and Items 10 and 11; the cross-loading involved the loading of Item 12 on Factor 1 (Emotional Exhaustion) in addition to its targeted Factor 3 (Personal Accomplishment)

```{r}
```
xie

```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```




```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```

